(function(){"use strict";var h=(e=>(e.NORMAL_SUDOKU="normal-sudoku",e.KINGS_MOVE="kings-move",e.KNIGHTS_MOVE="knights-move",e.KILLER_SUDOKU="killer-sudoku",e))(h||{});const O={easy:38,normal:30,hard:23,expert:17},k={[h.NORMAL_SUDOKU]:0,[h.KINGS_MOVE]:4,[h.KNIGHTS_MOVE]:7,[h.KILLER_SUDOKU]:0},a=9,w=9,v=(e,o,n,s)=>{const r=s%a,t=Math.floor(s/a);for(let i=0;i<a;i++){const u=t*a+i,m=r+i*a;if(u!==s&&o[u]===n||m!==s&&o[m]===n)return!1}const c=Math.floor(t/3)*3,l=Math.floor(r/3)*3,f=c+3,d=l+3;for(let i=c;i<f;i++)for(let u=l;u<d;u++){const m=i*a+u;if(m!==s&&o[m]===n)return!1}return!0},U=(e,o,n,s)=>{for(let r=-1;r<=1;r++)for(let t=-1;t<=1;t++){const c=s+r*a+t;if(c!==s&&o[c]===n)return!1}return!0},E=(e,o,n,s)=>{const r=s%a,t=Math.floor(s/a),c=[{col:r-2,row:t-1},{col:r-2,row:t+1},{col:r-1,row:t-2},{col:r-1,row:t+2},{col:r+1,row:t-2},{col:r+1,row:t+2},{col:r+2,row:t-1},{col:r+2,row:t+1}];for(const l of c)if(l.col>=0&&l.col<a&&l.row>=0&&l.row<a){const f=l.row*a+l.col;if(o[f]===n)return!1}return!0},C=(e,o,n,s)=>{const{cages:r}=e,t=s%a,c=Math.floor(s/a);for(const l of r){if(!l.path.find(i=>i.col===t&&i.row===c))continue;if(l.path.find(i=>o[i.col+i.row*w]===n))return!1}return!0},L={[h.NORMAL_SUDOKU]:v,[h.KINGS_MOVE]:U,[h.KNIGHTS_MOVE]:E,[h.KILLER_SUDOKU]:C},I=(e,o,n,s,r)=>{for(const t of e)if(!L[t](o,n,s,r))return!1;return!0},S=e=>{for(let o=e.length-1;o>0;o--){const n=Math.floor(Math.random()*(o+1)),s=e[o];e[o]=e[n],e[n]=s}},K=(e,o,n,s=0)=>{if(s===n.length)return!0;const r=[1,2,3,4,5,6,7,8,9];for(;r.length;){const[t]=r.splice(Math.floor(Math.random()*r.length),1);if(I(e,o,n,t,s)&&(n[s]=t,K(e,o,n,s+1)))return!0}return n[s]=null,!1},_=e=>{for(let o=0;o<e.length;o++)if(e[o]===null)return o;return null},x=(e,o)=>{let n=0;return function s(r,t=0){if(n++,n>1e5)throw new Error("enough");if(t>1)return t;const c=_(r);if(c!==null)for(let l=1;l<=9;l++)I(e,o,r,l,c)&&(r[c]=l,t=s(r,t),r[c]=null);else t++;return t}},p=(e,o,n,s)=>{try{const r=x(n,s),t=e.slice(),c=[...t.keys()];S(c);let l=t.length-1-O[o];for(const f of n)l+=k[f];for(let f=0;f<=l;){const d=c.pop(),i=t[d];t[d]=null,r(t.slice())===1?f++:(t[d]=i,c.unshift(d))}return t}catch{return p(e,o,n,s)}},V=()=>{const e=[],o={min:3,max:6},n={min:3,max:6},s=Math.floor(Math.random()*(n.max-n.min+1))+n.min,r=[],t=[...Array(w*a).keys()];S(t);o:for(let c=0;c<s;c++){let l=0;const f=Math.floor(Math.random()*(o.max-o.min+1))+o.min,d=[],i=t.pop();let u=i%w,m=Math.floor(i/w);for(;d.length<f;){if(l++,l>100){c--;continue o}if(Math.random()>.5){const M=u+(Math.random()>.5?1:-1),g=M+m*w;if(M<0||M>=w||r.includes(g))continue;u=M}else{const M=m+(Math.random()>.5?1:-1),g=u+M*w;if(M<0||M>=a||r.includes(g))continue;m=M}const G=u+m*w;r.push(G),d.push({col:u,row:m})}e[c]={size:f,path:d,total:0}}return e},N=(e,o)=>{for(const n of e){n.total=0;for(const{col:s,row:r}of n.path)n.total+=o[s+r*w].answer}},R=e=>{const o={};for(const n of e)switch(n){case h.KILLER_SUDOKU:o.cages=V();break}return o},D=(e,o,n)=>{const s={...o};for(const r of e)switch(r){case h.KILLER_SUDOKU:N(s.cages,n);break}return s},A=({difficulty:e,rules:o})=>{const n=R(o),s=new Array(a*w).fill(null);K(o,n,s);const r=p(s,e,o,n),t=[];for(let c=0;c<s.length;c+=1)t.push({value:null,answer:s[c],revealed:r[c]!==null,corner:[],middle:[],col:c%a,row:Math.floor(c/a),colors:[]});return{cells:t,meta:D(o,n,t)}};onmessage=({data:e})=>{postMessage(A(JSON.parse(e)))}})();
